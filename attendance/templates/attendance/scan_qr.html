{% extends 'attendance/base.html' %}

{% block title %}QR Scanner - Library System{% endblock %}

{% block content %}
<div class="card">
    <h1 style="text-align: center; margin-bottom: 2rem;">üì± Library Check-In/Out</h1>
    
    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div style="text-align: center; padding: 1rem; background: #e8f4fd; border-radius: 10px;">
            <h3>Today's Visitors</h3>
            <div id="today-count" style="font-size: 2rem; font-weight: bold; color: #667eea;">{{ today_count }}</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #e8f4fd; border-radius: 10px;">
            <h3>Currently in Library</h3>
            <div id="current-in-library" style="font-size: 2rem; font-weight: bold; color: #28a745;">{{ current_in_library }}</div>
        </div>
    </div>

    <!-- Scanner Options -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <!-- USB QR Scanner -->
        <div style="padding: 2rem; background: #f8f9fa; border-radius: 10px;">
            <h3>üîç USB QR Scanner</h3>
            <p style="color: #666; margin-bottom: 1rem;">For dedicated QR scanner devices</p>
            
            <form method="post" id="scanner-form">
                {% csrf_token %}
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           name="school_id_number" 
                           id="scanner-input"
                           placeholder="QR scanner will auto-fill here..." 
                           style="width: 100%; padding: 1rem; font-size: 1.1rem; border: 2px solid #28a745; border-radius: 8px; text-align: center; background: #f8fff9;"
                           autofocus required>
                </div>
                <div id="scanner-status" style="color: #28a745; font-weight: bold; margin: 10px 0;">
                    ‚úÖ Scanner ready - waiting for input...
                </div>
            </form>
        </div>

        <!-- Webcam QR Scanner -->
        <div style="padding: 2rem; background: #f8f9fa; border-radius: 10px;">
            <h3>üì∑ Webcam QR Scanner</h3>
            <p style="color: #666; margin-bottom: 1rem;">Webcam automatically scans for QR codes</p>
            
            <div id="webcam-section">
                <div id="webcam-container">
                    <video id="webcam" width="100%" autoplay playsinline></video>
                    <canvas id="webcam-canvas" style="display: none;"></canvas>
                    <button onclick="stopWebcamScanner()" class="btn" style="background: #dc3545; margin-top: 1rem; display: none;" id="stop-webcam-btn">
                        Stop Webcam
                    </button>
                </div>
                <div id="webcam-status" style="min-height: 20px; margin: 10px 0;">
                    üîÑ Starting webcam scanner...
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div style="background: #d4edda; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #28a745;">
        <h4>üéØ Setup Instructions:</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <h5>USB QR Scanner:</h5>
                <ul style="text-align: left; color: #155724;">
                    <li>Plug in USB QR scanner</li>
                    <li>Scan QR codes - auto-submits!</li>
                    <li>No software needed</li>
                </ul>
            </div>
            <div>
                <h5>Webcam Scanner:</h5>
                <ul style="text-align: left; color: #155724;">
                    <li>Webcam starts automatically</li>
                    <li>Allow camera permissions when prompted</li>
                    <li>Point QR code at webcam</li>
                    <li>Auto-detects and submits instantly</li>
                    <li>Continuous scanning - no restart needed!</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div style="text-align: center; margin-top: 2rem;">
    <a href="{% url 'student_qr_codes' %}" class="btn btn-success">üé´ QR Codes</a>
    <a href="{% url 'scanner_test' %}" class="btn">üß™ Scanner Test</a>
    <a href="{% url 'dashboard' %}" class="btn">üìä Dashboard</a>
</div>

<!-- Student Notification Popup -->
<div id="student-popup" class="popup-container" style="display: none;">
    <div class="popup-content">
        <div class="popup-header">
            <h2 id="popup-title">Check-In Successful</h2>
            <span id="popup-close" onclick="closePopup()">√ó</span>
        </div>
        <div class="popup-body">
            <div class="student-avatar">üë§</div>
            <div class="student-info">
                <h3 id="popup-student-name">Student Name</h3>
                <p id="popup-student-id">ID: 123456</p>
                <p id="popup-education-stage">Grade: College</p>
                <p id="popup-time">Time: 14:30:45</p>
            </div>
        </div>
        <div class="popup-footer">
            <div id="popup-countdown">Closing in 3 seconds...</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
// USB QR Scanner functionality
document.addEventListener('DOMContentLoaded', function() {
    const scannerInput = document.getElementById('scanner-input');
    const scannerForm = document.getElementById('scanner-form');
    const scannerStatus = document.getElementById('scanner-status');
    
    // Prevent default form submission and use AJAX instead
    scannerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const studentId = scannerInput.value;
        if (studentId) {
            processStudentScan(studentId, 'usb');
        }
    });
    
    // Auto-submit when QR scanner inputs data
    scannerInput.addEventListener('input', function(e) {
        if (this.value.length > 0) {
            scannerStatus.textContent = 'üîÑ Processing scan...';
            
            // Use AJAX instead of form submission
            const studentId = this.value;
            processStudentScan(studentId, 'usb');
        }
    });
    
    scannerInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            scannerStatus.textContent = 'üîÑ Processing scan...';
            const studentId = scannerInput.value;
            if (studentId) {
                processStudentScan(studentId, 'usb');
            }
        }
    });
    
    scannerInput.focus();
});

// Webcam QR Scanner functionality
let webcamStream = null;
let webcamScanning = false;

// Auto-start webcam when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(startWebcamScanner, 1000); // Start after 1 second
});

async function startWebcamScanner() {
    const webcam = document.getElementById('webcam');
    const webcamStatus = document.getElementById('webcam-status');
    const stopWebcamBtn = document.getElementById('stop-webcam-btn');
    
    try {
        webcamStatus.innerHTML = 'üîÑ Requesting camera access...';
        
        // Request camera access
        webcamStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "environment",
                width: { ideal: 640 },
                height: { ideal: 480 }
            },
            audio: false 
        });
        
        webcam.srcObject = webcamStream;
        webcamStatus.innerHTML = '<span style="color: #28a745;">‚úÖ Webcam active! Point QR code at camera.</span>';
        stopWebcamBtn.style.display = 'inline-block';
        
        // Start QR code scanning
        webcamScanning = true;
        scanQRFromWebcam();
        
    } catch (error) {
        console.error('Webcam error:', error);
        if (error.name === 'NotAllowedError') {
            webcamStatus.innerHTML = '<span style="color: #dc3545;">‚ùå Camera permission denied. Please allow camera access and refresh the page.</span>';
        } else if (error.name === 'NotFoundError') {
            webcamStatus.innerHTML = '<span style="color: #dc3545;">‚ùå No webcam found. Please connect a webcam.</span>';
        } else if (error.name === 'NotSupportedError') {
            webcamStatus.innerHTML = '<span style="color: #dc3545;">‚ùå Webcam not supported in this browser.</span>';
        } else {
            webcamStatus.innerHTML = `<span style="color: #dc3545;">‚ùå Webcam error: ${error.message}</span>`;
        }
    }
}

function stopWebcamScanner() {
    if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
    }
    webcamScanning = false;
    document.getElementById('webcam-status').innerHTML = '<span style="color: #666;">Webcam stopped. Refresh page to restart.</span>';
    document.getElementById('stop-webcam-btn').style.display = 'none';
}

function scanQRFromWebcam() {
    if (!webcamScanning) return;
    
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('webcam-canvas');
    const context = canvas.getContext('2d');
    const webcamStatus = document.getElementById('webcam-status');
    
    if (webcam.readyState === webcam.HAVE_ENOUGH_DATA) {
        canvas.width = webcam.videoWidth;
        canvas.height = webcam.videoHeight;
        context.drawImage(webcam, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            webcamStatus.innerHTML = `<span style="color: #28a745;">‚úÖ QR detected: ${code.data} - Processing...</span>`;
            
            // Stop scanning temporarily while processing
            webcamScanning = false;
            
            // Process the scan
            processStudentScan(code.data, 'webcam');
            
            // Don't return - we'll restart scanning after processing
        } else {
            // No QR code found, continue scanning
            if (webcamScanning) {
                requestAnimationFrame(scanQRFromWebcam);
            }
        }
    } else {
        // Webcam not ready yet, try again
        if (webcamScanning) {
            requestAnimationFrame(scanQRFromWebcam);
        }
    }
}

// Function to update statistics
async function updateStatistics() {
    try {
        const response = await fetch('/attendance/api/statistics/');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('today-count').textContent = data.today_count;
            document.getElementById('current-in-library').textContent = data.current_in_library;
        }
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// Student notification popup functions
function showStudentPopup(studentData, action) {
    const popup = document.getElementById('student-popup');
    const title = document.getElementById('popup-title');
    const studentName = document.getElementById('popup-student-name');
    const studentId = document.getElementById('popup-student-id');
    const educationStage = document.getElementById('popup-education-stage');
    const time = document.getElementById('popup-time');
    const countdown = document.getElementById('popup-countdown');
    
    // Set popup content
    title.textContent = action === 'check_in' ? '‚úÖ Check-In Successful' : 'üö™ Check-Out Successful';
    studentName.textContent = studentData.name;
    studentId.textContent = `ID: ${studentData.school_id}`;  // Updated field name
    educationStage.textContent = `Grade: ${studentData.education_stage}`;
    time.textContent = `Time: ${new Date().toLocaleTimeString()}`;
    
    // Update statistics immediately when popup shows
    updateStatistics();
    
    // Show popup
    popup.style.display = 'flex';
    
    // Start countdown
    let seconds = 3;
    countdown.textContent = `Closing in ${seconds} seconds...`;
    
    const countdownInterval = setInterval(() => {
        seconds--;
        countdown.textContent = `Closing in ${seconds} second${seconds !== 1 ? 's' : ''}...`;
        
        if (seconds <= 0) {
            clearInterval(countdownInterval);
            closePopup();
        }
    }, 1000);
}

function closePopup() {
    const popup = document.getElementById('student-popup');
    popup.style.display = 'none';
    
    // Reset scanner input and focus for next scan
    document.getElementById('scanner-input').value = '';
    document.getElementById('scanner-input').focus();
    
    // Resume webcam scanning
    if (webcamStream) {
        webcamScanning = true;
        // Restart the scanning loop
        setTimeout(() => {
            scanQRFromWebcam();
        }, 500); // Small delay before resuming
    }
    
    // Update scanner status
    document.getElementById('scanner-status').textContent = '‚úÖ Scanner ready - waiting for input...';
    document.getElementById('webcam-status').innerHTML = '<span style="color: #28a745;">‚úÖ Webcam active! Point QR code at camera.</span>';
}

// Process student scan and show popup
async function processStudentScan(studentId, source) {
    try {
        const response = await fetch('/attendance/api/scan-with-details/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'school_id_number=' + encodeURIComponent(studentId)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Show popup with student details
                showStudentPopup(result.student, result.action);
                
                // Update statistics after successful scan
                updateStatistics();
            } else {
                // Show error popup
                showErrorPopup(result.error || 'Unknown error occurred');
                
                // Resume scanning immediately on error
                if (source === 'webcam' && webcamStream) {
                    webcamScanning = true;
                    setTimeout(() => {
                        scanQRFromWebcam();
                    }, 1000);
                }
            }
        } else {
            showErrorPopup('Server error occurred');
            
            // Resume scanning immediately on error
            if (source === 'webcam' && webcamStream) {
                webcamScanning = true;
                setTimeout(() => {
                    scanQRFromWebcam();
                }, 1000);
            }
        }
        
    } catch (error) {
        console.error('Scan processing error:', error);
        showErrorPopup('Network error occurred');
        
        // Resume scanning immediately on error
        if (source === 'webcam' && webcamStream) {
            webcamScanning = true;
            setTimeout(() => {
                scanQRFromWebcam();
            }, 1000);
        }
    }
}

function showErrorPopup(message) {
    const popup = document.getElementById('student-popup');
    const title = document.getElementById('popup-title');
    const studentName = document.getElementById('popup-student-name');
    const studentId = document.getElementById('popup-student-id');
    const educationStage = document.getElementById('popup-education-stage');
    const time = document.getElementById('popup-time');
    const countdown = document.getElementById('popup-countdown');
    
    // Set error popup content
    title.textContent = '‚ùå Error';
    studentName.textContent = message;
    studentId.textContent = '';
    educationStage.textContent = '';
    time.textContent = `Time: ${new Date().toLocaleTimeString()}`;
    
    // Show popup
    popup.style.display = 'flex';
    
    // Start countdown
    let seconds = 3;
    countdown.textContent = `Closing in ${seconds} seconds...`;
    
    const countdownInterval = setInterval(() => {
        seconds--;
        countdown.textContent = `Closing in ${seconds} second${seconds !== 1 ? 's' : ''}...`;
        
        if (seconds <= 0) {
            clearInterval(countdownInterval);
            closePopup();
        }
    }, 1000);
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        webcamScanning = false;
    } else {
        if (webcamStream && !webcamScanning) {
            webcamScanning = true;
            scanQRFromWebcam();
        }
    }
});

// Handle window focus/blur events
window.addEventListener('blur', function() {
    webcamScanning = false;
});

window.addEventListener('focus', function() {
    if (webcamStream && !webcamScanning) {
        webcamScanning = true;
        scanQRFromWebcam();
    }
});

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
/* Popup Styles */
.popup-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.popup-content {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 400px;
    overflow: hidden;
    animation: popupAppear 0.3s ease-out;
}

@keyframes popupAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.popup-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.popup-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

#popup-close {
    font-size: 2rem;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.popup-body {
    padding: 30px 20px;
    text-align: center;
}

.student-avatar {
    font-size: 4rem;
    margin-bottom: 15px;
}

.student-info h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.4rem;
}

.student-info p {
    margin: 5px 0;
    color: #666;
    font-size: 1rem;
}

.popup-footer {
    background: #f8f9fa;
    padding: 15px 20px;
    text-align: center;
    border-top: 1px solid #e9ecef;
}

#popup-countdown {
    color: #666;
    font-size: 0.9rem;
}

#webcam {
    border-radius: 8px;
    border: 2px solid #007bff;
    background: #000;
}

#webcam-status {
    font-weight: bold;
    padding: 8px;
    border-radius: 4px;
}
</style>
{% endblock %}